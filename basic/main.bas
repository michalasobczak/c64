0 ? fre(1)+65536
1 rem ***** start *****
2 t1=ticks: t2=0
3 ? "=> data initialization"
4 ? fre(1)+65536

20 rem ***** data *****
21 v=0: fs=0: nb=5
22 tx=0:ty=0:tz=0
23 p1=0: p2=0: p3=0: p4=0: p5=0: p6=0: p7=0: p8=0: p9=0
24 fa=1
25 dim m1(8): dim m2(8)
26 dim d1(8): dim d2(8): dim d3(8) 
27   d1(0)=1: d1(1)=0:   d1(2)=0
28   d1(3)=0: d1(4)=100: d1(5)=100
29   d1(6)=0: d1(7)=100: d1(8)=100
30   d2(0)=100: d2(1)=0:  d2(2)=100
31   d2(3)=0:   d2(4)=1:  d2(5)=0
32   d2(6)=100: d2(7)=0:  d2(8)=100
33   d3(0)=100: d3(1)=100:  d3(2)=0
34   d3(3)=100: d3(4)=100:  d3(5)=0
35   d3(6)=0:   d3(7)=0:    d3(8)=1
36 dim d4(2): dim d5(2)
37   d4(0)=0: d4(1)=0: d4(2)=0
38   d5(0)=0: d5(2)=0: d5(2)=0
39 dim ms(8)
40   ms(0)=0: ms(1)=0: ms(2)=0
41   ms(3)=0: ms(4)=0: ms(5)=0
42   ms(6)=0: ms(7)=0: ms(8)=0
43 dim mv(2)
44 dz=0: nx=0: ny=0: ch=160
45 re=0
46 px=250: py=40: pz=1500
47 cx=200: cy=335: cz=-250
48 ? fre(1)+65536

49 gosub 900: goto 1000

50 rem ***** getT *****
51 if fs=0 then nb=0
60 if fs=1 then nb=1
70 return

100 rem ***** transform3into2_new *****
101 ?"...": t1=ticks: fs=1: v=tx: d1(4)=1
102   fs=0: v=tx: d1(5)=-1*0
103   fs=0: v=tx: d1(7)=0
104   fs=1: v=tx: d1(8)=1
105 fs=1: v=ty: d2(0)=1
106   fs=0: v=ty: d2(2)=0
107   fs=0: v=ty: d2(6)=-1*0
108   fs=1: v=ty: d2(8)=1
109 fs=1: v=tz: d3(0)=1
110   fs=0: v=tz: d3(1)=-1*0
111   fs=0: v=tz: d3(3)=0
112   fs=1: v=tz: d3(4)=1
113     rem for i=0 to 8 step 1: ? d1(i);: next i: ? " "
114     rem for i=0 to 8 step 1: ? d2(i);: next i: ? " "
115     rem for i=0 to 8 step 1: ? d3(i);: next i: ? " "
116       ?"116",:gosub 900
120 p1=(d1(0)*d2(0))+(d1(1)*d2(3))+(d1(2)*d2(6))
121   p2=(d1(0)*d2(1))+(d1(1)*d2(4))+(d1(2)*d2(7))
122   p3=(d1(0)*d2(2))+(d1(1)*d2(5))+(d1(2)*d2(8))
123   p4=(d1(3)*d2(0))+(d1(4)*d2(3))+(d1(5)*d2(6))
124   p5=(d1(3)*d2(1))+(d1(4)*d2(4))+(d1(5)*d2(7))
125   p6=(d1(3)*d2(2))+(d1(4)*d2(5))+(d1(5)*d2(8))
126   p7=(d1(6)*d2(0))+(d1(7)*d2(3))+(d1(8)*d2(6))
127   p8=(d1(6)*d2(1))+(d1(7)*d2(4))+(d1(8)*d2(7))
128   p9=(d1(6)*d2(2))+(d1(7)*d2(5))+(d1(8)*d2(8))
129   m1(0)=p1: m1(1)=p2: m1(2)=p3
130   m1(3)=p4: m1(4)=p5: m1(5)=p6
131   m1(6)=p7: m1(7)=p8: m1(8)=p9
132     rem for i=0 to 8 step 1: ? m1(i);: next i: ? " "
133       ?"133",:gosub 900
140 p1=(m1(0)*d3(0))+(m1(1)*d3(3))+(m1(2)*d3(6))
141   p2=(m1(0)*d3(1))+(m1(1)*d3(4))+(m1(2)*d3(7))
142   p3=(m1(0)*d3(2))+(m1(1)*d3(5))+(m1(2)*d3(8))
143   p4=(m1(3)*d3(0))+(m1(4)*d3(3))+(m1(5)*d3(6))
144   p5=(m1(3)*d3(1))+(m1(4)*d3(4))+(m1(5)*d3(7))
145   p6=(m1(3)*d3(2))+(m1(4)*d3(5))+(m1(5)*d3(8))
146   p7=(m1(6)*d3(0))+(m1(7)*d3(3))+(m1(8)*d3(6))
147   p8=(m1(6)*d3(1))+(m1(7)*d3(4))+(m1(8)*d3(7))
148   p9=(m1(6)*d3(2))+(m1(7)*d3(5))+(m1(8)*d3(8))
149   m2(0)=p1: m2(1)=p2: m2(2)=p3
150   m2(3)=p4: m2(4)=p5: m2(5)=p6
151   m2(6)=p7: m2(7)=p8: m2(8)=p9
152     rem for i=0 to 8 step 1: ? m2(i);: next i: ? " "
153       ?"153",:gosub 900
160 d4(0)=px: d4(1)=py: d4(2)=pz
161 d5(0)=cx: d5(1)=cy: d5(2)=cz 
170 ms(0)=d4(0)-d5(0)
171 ms(1)=d4(1)-d5(1)
172 ms(2)=d4(2)-d5(2)
173   rem for i=0 to 8 step 1: ? ms(i);: next i: ? " "
174     ?"174",:gosub 900
180 p1=(m2(0)*ms(0))+(m2(1)*ms(1))+(m2(2)*ms(2))
181 p2=(m2(3)*ms(0))+(m2(4)*ms(1))+(m2(5)*ms(2)) 
182 p3=(m2(6)*ms(0))+(m2(7)*ms(1))+(m2(8)*ms(2)) 
190 mv(0)=p1: mv(1)=p2: mv(2)=p3
191   rem for i=0 to 2 step 1: ? mv(i);: next i: ? " "
192     ?"192",:gosub 900
200 dz=(-700)/mv(2)
201 nx=-1*(mv(0)*dz) + ch
202 ny=(mv(1)*dz)
210 rem ?px,py,pz: ?nx,ny 
211   ?"211",:gosub 900
299 return

900 rem ****** ticks ******
901 t2 = ticks
902 ? "took:" int((t2-t1)) " ticks"
903 return

1000 rem ****** main ******
1001 ? "=> starting"
1002 ? " => run"
1003 px=250: py=40: pz=1500
1004 cx=200: cy=335: cz=-250
1005 tx=0: ty=0: tz=0
1006 gosub 100: ? fre(1)+65536
1007 gosub 100: ? fre(1)+65536
1008 gosub 100: ? fre(1)+65536
1009 gosub 100: ? fre(1)+65536
1010 gosub 100: ? fre(1)+65536

3000 ? "=> finish"
3001 end
3002 ? fre(1)+65536
